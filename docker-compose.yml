version: '2.4'

services:

  spring-cloud-config:
    build: spring-cloud-config-server/
    container_name: cloud-config
    ports:
      - "8888:8888"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8888/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: always

  discovery-service:
    build: discovery-service/
    container_name: eureka-server
    ports:
      - "8761:8761"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8761/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: always

#todo add zuul in compose
  gateway-service:
    build: gateway-service/
    container_name: gateway-service
    ports:
      - "5555:5555"
    healthcheck:
      test:  [ "CMD", "curl", "-f", "http://localhost:5555/actuator/health" ]
      interval: 25s
      timeout: 5s
      retries: 3
    depends_on:
      cloud-config:
        condition: service_healthy
      study-center:
        condition: service_healthy
      payment-service:
        condition: service_healthy
    environment:
      - CONFIG_URL=http://spring-cloud-config:8888
      - EUREKA_URI=http://eureka-server:8761/eureka/
      - STUDY_CENTER_NAME=study-center
      - PAYMENT_SERVICE_NAME=payment-service
    restart: always


  payment-service:
    build: payment-service/
    container_name: payment-service
    ports:
      - "8189:8189"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://payment-service:8189/actuator/health" ]
      interval: 25s
      timeout: 5s
      retries: 4
    depends_on:
      cloud-config:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      payment-db:
        condition: service_started
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=payment-db
      - POSTGRES_URL=payment-db:5432/payment-db
      - CONFIG_URL=http://spring-cloud-config:8888
      - EUREKA_URI=http://eureka-server:8761/eureka/
    restart: always

  study-center:
    build: study-center/
    container_name: study-center
    ports:
      - "8190:8190"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://study_center:8190/actuator/health" ]
      interval: 25s
      timeout: 5s
      retries: 4
    depends_on:
      cloud-config:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      payment-service:
        condition: service_healthy
      study-db:
        condition: service_started
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=study-db
      - POSTGRES_URL=study-db:5432/study-db
      - SOAP_URL=http://payment-service:8189/api/v1/soap
      - CONFIG_URL=http://spring-cloud-config:8888
      - EUREKA_URI=http://eureka-server:8761/eureka/
    restart: always

  payment-db:
    image: postgres:14.1-alpine
    container_name: payment-db
    expose:
      - "5432"
    volumes:
      - ./.docker/database/init/payment:/docker-entrypoint-initdb.d/
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=payment-db

  study-db:
    image: postgres:14.1-alpine
    container_name: study-db
    expose:
      - "5432"
    volumes:
      - ./.docker/database/init/study:/docker-entrypoint-initdb.d/
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=study-db